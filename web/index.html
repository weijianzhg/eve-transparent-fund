<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eve Transparent Fund ü¶ã</title>
  <style>
    :root {
      --bg: #0a0a0f;
      --card: #12121a;
      --border: #2a2a3a;
      --text: #e0e0e0;
      --muted: #888;
      --accent: #6366f1;
      --green: #22c55e;
      --blue: #3b82f6;
      --orange: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 2rem;
    }
    h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    .subtitle { color: var(--muted); }
    .live-badge {
      display: inline-block;
      background: var(--green);
      color: white;
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      margin-left: 0.5rem;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .card h2 {
      font-size: 1rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
    }
    .stat {
      text-align: center;
      padding: 1rem;
      background: var(--bg);
      border-radius: 8px;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }
    .stat-value.green { color: var(--green); }
    .stat-value.blue { color: var(--blue); }
    .stat-value.orange { color: var(--orange); }
    .stat-label {
      font-size: 0.75rem;
      color: var(--muted);
    }
    .address {
      font-family: monospace;
      background: var(--bg);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      word-break: break-all;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .address button {
      background: var(--accent);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
    }
    .address button:hover { opacity: 0.9; }
    .timeline {
      border-left: 2px solid var(--border);
      padding-left: 1.5rem;
      margin-left: 0.5rem;
    }
    .event {
      position: relative;
      margin-bottom: 1.5rem;
    }
    .event::before {
      content: '';
      position: absolute;
      left: -1.75rem;
      top: 0.5rem;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
    }
    .event.donation::before { background: var(--green); }
    .event.allocation::before { background: var(--blue); }
    .event.proof::before { background: var(--orange); }
    .event-time {
      font-size: 0.75rem;
      color: var(--muted);
    }
    .event-title {
      font-weight: 600;
      margin: 0.25rem 0;
    }
    .event-detail {
      font-size: 0.875rem;
      color: var(--muted);
    }
    .event-link {
      font-size: 0.75rem;
    }
    .tag {
      display: inline-block;
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      background: var(--accent);
      color: white;
      margin-right: 0.5rem;
    }
    .tag.donation { background: var(--green); }
    .tag.allocation { background: var(--blue); }
    .tag.proof { background: var(--orange); }
    .section-divider {
      text-align: center;
      color: var(--muted);
      font-size: 0.75rem;
      margin: 2rem 0 1rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    footer {
      text-align: center;
      margin-top: 2rem;
      color: var(--muted);
      font-size: 0.875rem;
    }
    a { color: var(--accent); }
    .loading { color: var(--muted); font-style: italic; }
    .error { color: #ef4444; }
    .empty { color: var(--muted); font-style: italic; text-align: center; padding: 1rem; }
  </style>
</head>
<body>
  <header>
    <h1>Eve Transparent Fund ü¶ã <span class="live-badge">LIVE</span></h1>
    <p class="subtitle">Transparent micro-grants on Solana (Devnet)</p>
  </header>

  <div class="card">
    <h2>Fund Address</h2>
    <div class="address">
      <span id="fund-address">5D4hWLFW8m76gYEfHSETR86vbxeGegRvg4b2tn45XxXu</span>
      <button onclick="copyAddress()">Copy</button>
    </div>
  </div>

  <div class="card">
    <h2>On-Chain Status <span id="status-indicator" class="loading">(loading...)</span></h2>
    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="balance-sol">‚Äî</div>
        <div class="stat-label">SOL Balance</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="tx-count">‚Äî</div>
        <div class="stat-label">Transactions</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Fund Tracker <span id="tracker-indicator" class="loading">(loading...)</span></h2>
    <div class="stats">
      <div class="stat">
        <div class="stat-value green" id="total-received">‚Äî</div>
        <div class="stat-label">Total Received</div>
      </div>
      <div class="stat">
        <div class="stat-value blue" id="total-allocated">‚Äî</div>
        <div class="stat-label">Allocated</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="total-remaining">‚Äî</div>
        <div class="stat-label">Remaining</div>
      </div>
      <div class="stat">
        <div class="stat-value orange" id="proof-count">‚Äî</div>
        <div class="stat-label">Proofs</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Audit Trail</h2>
    <div class="timeline" id="audit-trail">
      <p class="loading">Loading fund data...</p>
    </div>
  </div>

  <div class="section-divider">Raw Chain Data</div>

  <div class="card">
    <h2>Recent On-Chain Transactions</h2>
    <div class="timeline" id="timeline">
      <p class="loading">Loading from Solana...</p>
    </div>
  </div>

  <div class="card">
    <h2>How It Works</h2>
    <p style="color: var(--muted); margin-bottom: 1rem;">
      Every donation is verified on-chain before recording. Allocations are tracked with stated purposes. 
      Recipients submit proof of impact. Anyone can audit the full trail.
    </p>
    <p>
      <a href="https://github.com/weijianzhg/eve-transparent-fund" target="_blank">View Source</a> ¬∑ 
      <a href="https://github.com/weijianzhg/eve-transparent-fund/blob/main/skill.md" target="_blank">Agent Skill</a> ¬∑ 
      <a href="https://explorer.solana.com/address/5D4hWLFW8m76gYEfHSETR86vbxeGegRvg4b2tn45XxXu?cluster=devnet" target="_blank">Solana Explorer</a>
    </p>
  </div>

  <footer>
    Built by Eve ü¶ã for the <a href="https://colosseum.com/agent-hackathon">Colosseum Agent Hackathon</a>
  </footer>

  <script>
    const FUND_ADDRESS = '5D4hWLFW8m76gYEfHSETR86vbxeGegRvg4b2tn45XxXu';
    const RPC_URL = 'https://api.devnet.solana.com';
    const API_URL = '/api/fund';

    function copyAddress() {
      const addr = document.getElementById('fund-address').textContent;
      navigator.clipboard.writeText(addr);
      event.target.textContent = 'Copied!';
      setTimeout(() => event.target.textContent = 'Copy', 2000);
    }

    async function rpc(method, params) {
      const res = await fetch(RPC_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ jsonrpc: '2.0', id: 1, method, params })
      });
      const json = await res.json();
      if (json.error) throw new Error(json.error.message);
      return json.result;
    }

    async function loadBalance() {
      try {
        const result = await rpc('getBalance', [FUND_ADDRESS]);
        const sol = (result.value / 1e9).toFixed(4);
        document.getElementById('balance-sol').textContent = sol;
      } catch (e) {
        document.getElementById('balance-sol').textContent = 'Error';
        console.error('Balance error:', e);
      }
    }

    async function loadTransactions() {
      const timeline = document.getElementById('timeline');
      try {
        const sigs = await rpc('getSignaturesForAddress', [FUND_ADDRESS, { limit: 10 }]);
        document.getElementById('tx-count').textContent = sigs.length;
        
        if (sigs.length === 0) {
          timeline.innerHTML = '<p class="empty">No transactions yet</p>';
          return;
        }

        let html = '';
        for (const sig of sigs) {
          const time = sig.blockTime 
            ? new Date(sig.blockTime * 1000).toLocaleString('en-US', { 
                month: 'short', day: 'numeric', year: 'numeric', 
                hour: '2-digit', minute: '2-digit', timeZoneName: 'short' 
              })
            : 'Unknown time';
          
          const shortSig = sig.signature.slice(0, 8) + '...' + sig.signature.slice(-8);
          const explorerUrl = `https://explorer.solana.com/tx/${sig.signature}?cluster=devnet`;
          
          html += `
            <div class="event donation">
              <div class="event-time">${time}</div>
              <div class="event-title"><span class="tag donation">TX</span> ${shortSig}</div>
              <div class="event-link"><a href="${explorerUrl}" target="_blank">View on Explorer ‚Üí</a></div>
            </div>
          `;
        }
        timeline.innerHTML = html;
        document.getElementById('status-indicator').textContent = '(live from devnet)';
        document.getElementById('status-indicator').className = '';
      } catch (e) {
        timeline.innerHTML = `<p class="error">Failed to load: ${e.message}</p>`;
        document.getElementById('status-indicator').textContent = '(error)';
        document.getElementById('status-indicator').className = 'error';
        console.error('Transactions error:', e);
      }
    }

    async function loadFundTracker() {
      const auditTrail = document.getElementById('audit-trail');
      const trackerIndicator = document.getElementById('tracker-indicator');
      
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        
        // Update summary stats
        const sol = data.summary?.sol || { received: 0, allocated: 0, remaining: 0 };
        document.getElementById('total-received').textContent = sol.received.toFixed(2) + ' SOL';
        document.getElementById('total-allocated').textContent = sol.allocated.toFixed(2) + ' SOL';
        document.getElementById('total-remaining').textContent = sol.remaining.toFixed(2) + ' SOL';
        document.getElementById('proof-count').textContent = data.summary?.proofs || 0;
        
        // Build audit trail
        const entries = [];
        
        for (const d of data.donations || []) {
          entries.push({ type: 'donation', data: d, timestamp: new Date(d.timestamp) });
        }
        for (const a of data.allocations || []) {
          entries.push({ type: 'allocation', data: a, timestamp: new Date(a.timestamp) });
        }
        for (const p of data.proofs || []) {
          entries.push({ type: 'proof', data: p, timestamp: new Date(p.timestamp) });
        }
        
        entries.sort((a, b) => b.timestamp - a.timestamp); // newest first
        
        if (entries.length === 0) {
          auditTrail.innerHTML = '<p class="empty">No tracked donations yet. Send SOL to the fund address to get started!</p>';
          trackerIndicator.textContent = `(${data.source || 'loaded'})`;
          trackerIndicator.className = '';
          return;
        }
        
        let html = '';
        for (const entry of entries) {
          const time = entry.timestamp.toLocaleString('en-US', { 
            month: 'short', day: 'numeric', year: 'numeric', 
            hour: '2-digit', minute: '2-digit'
          });
          
          if (entry.type === 'donation') {
            const d = entry.data;
            const shortTx = d.txHash.slice(0, 8) + '...' + d.txHash.slice(-8);
            const explorerUrl = `https://explorer.solana.com/tx/${d.txHash}?cluster=devnet`;
            html += `
              <div class="event donation">
                <div class="event-time">${time}</div>
                <div class="event-title"><span class="tag donation">DONATION</span> ${d.amount} ${d.currency}</div>
                <div class="event-detail">From: ${d.from.slice(0, 8)}...${d.from.slice(-4)}</div>
                ${d.memo ? `<div class="event-detail">Memo: ${d.memo}</div>` : ''}
                <div class="event-link"><a href="${explorerUrl}" target="_blank">${shortTx} ‚Üí</a></div>
              </div>
            `;
          }
          
          if (entry.type === 'allocation') {
            const a = entry.data;
            const shortTx = a.txHash.slice(0, 8) + '...' + a.txHash.slice(-8);
            const explorerUrl = `https://explorer.solana.com/tx/${a.txHash}?cluster=devnet`;
            html += `
              <div class="event allocation">
                <div class="event-time">${time}</div>
                <div class="event-title"><span class="tag allocation">ALLOCATION</span> ${a.amount} ${a.currency}</div>
                <div class="event-detail">To: ${a.recipientName}</div>
                <div class="event-detail">Purpose: ${a.purpose}</div>
                <div class="event-link"><a href="${explorerUrl}" target="_blank">${shortTx} ‚Üí</a></div>
              </div>
            `;
          }
          
          if (entry.type === 'proof') {
            const p = entry.data;
            html += `
              <div class="event proof">
                <div class="event-time">${time}</div>
                <div class="event-title"><span class="tag proof">PROOF</span> ${p.verified ? '‚úÖ Verified' : '‚è≥ Pending'}</div>
                <div class="event-detail">${p.description}</div>
                ${p.evidenceLinks?.length ? `<div class="event-link">${p.evidenceLinks.map(l => `<a href="${l}" target="_blank">Evidence ‚Üí</a>`).join(' ')}</div>` : ''}
              </div>
            `;
          }
        }
        
        auditTrail.innerHTML = html;
        trackerIndicator.textContent = `(${data.source || 'loaded'})`;
        trackerIndicator.className = '';
        
      } catch (e) {
        auditTrail.innerHTML = `<p class="error">Failed to load fund data: ${e.message}</p>`;
        trackerIndicator.textContent = '(error)';
        trackerIndicator.className = 'error';
        console.error('Fund tracker error:', e);
      }
    }

    // Load data on page load
    loadBalance();
    loadTransactions();
    loadFundTracker();

    // Refresh every 30 seconds
    setInterval(() => {
      loadBalance();
      loadTransactions();
      loadFundTracker();
    }, 30000);
  </script>
</body>
</html>
